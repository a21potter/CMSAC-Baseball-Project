---
title: "Initial Modeling"
author: "Amber Potter & Nicholas Esposito"
date: "7/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries and data
```{r}
library(baseballr)
library(glue)
library(tidyverse)
library(knitr)
library(ranger)
```

```{r}
statcast_data <- read_rds("data/statcast_data_clean.rds")

names(statcast_data)[1] <- 'pitch_id'
```

# Filter out 2020 and 2022 seasons
 
```{r}
statcast_data_minus_2020_2022 <- statcast_data %>%
  filter(!(game_year %in% c(2020, 2022)))
```

# Create an indicator for the last pitch of an at-bat

```{r}
statcast_data_minus_2020_2022 <- statcast_data_minus_2020_2022 %>%
  group_by(game_id, batter, at_bat_number) %>%
  #arrange(pitch_number) %>%
  mutate(pitch_count = max(pitch_number),
         last_pitch_of_at_bat = case_when(pitch_number == pitch_count ~ TRUE,
                                          TRUE ~ FALSE)) %>%
  ungroup()
```

# 200+ at bats

```{r}
statcast_data_minus_2020_2022 <- statcast_data_minus_2020_2022 %>%
  group_by(game_year, batter, stand, if_fielding_alignment) %>%
  mutate(total_player_at_bats = length(which(last_pitch_of_at_bat == TRUE))) %>%
  filter(total_player_at_bats >= 200)
```

# Filter out NA values in each field alignment category, extreme outfield shift, and spring training/exhibition games

```{r}
statcast_data_minus_2020_2022 <- statcast_data_minus_2020_2022 %>%
  filter(if_fielding_alignment != "", !of_fielding_alignment %in% c("", "Extreme outfield shift"), 
         !game_type %in% c("S", "E")) # Filter NAs, ex. outfield shift, and ST/E games
```

# Filter out potential infield-in situations

```{r}
statcast_data_minus_2020_2022 <- statcast_data_minus_2020_2022 %>%
  filter(!(on_3b != "" & outs_when_up < 2 & if_fielding_alignment == "Shift"))
```

# Reduce shifting categories to shift vs standard

```{r}
statcast_data_minus_2020_2022 <- statcast_data_minus_2020_2022 %>%
  mutate(general_fielding_alignment = 
           case_when(if_fielding_alignment == "Infield shift" |
                       of_fielding_alignment == "4th outfielder" ~ "Shift",
                     TRUE ~ "Standard"))

# Reduce shifting subcategories to Standard vs Shift
statcast_data_minus_2020_2022 <- statcast_data_minus_2020_2022 %>%
  mutate(if_fielding_alignment = 
           case_when(if_fielding_alignment == "Infield shift" ~ "Shift",
                     if_fielding_alignment == "Strategic" |
                       if_fielding_alignment == "Standard"~ "Standard")) %>%
  mutate(of_fielding_alignment = 
           case_when(of_fielding_alignment == "4th outfielder" ~ "Shift",
                     of_fielding_alignment == "Strategic" |
                       of_fielding_alignment == "Standard" ~ "Standard"))
```

# Adjust BABIP calculation to exclude NAs and variables not involved in finding BABIP

```{r}
statcast_data_minus_2020_2022 <- statcast_data_minus_2020_2022 %>%
  mutate(babip_value_with_NAs = case_when(last_pitch_of_at_bat == FALSE | events == "sac_bunt_double_play" | events == "sac_bunt" | events == "home_run" | description != "hit_into_play" ~ NA_real_,
                                          TRUE ~ babip_value))
```



```{r}
statcast_data_minus_2020_2022 <- statcast_data_minus_2020_2022 %>%
#  filter(last_pitch_of_at_bat == TRUE) %>%
  mutate(walk = case_when(events == "walk" ~ 1,
                          TRUE ~ 0),
         strikeout = case_when(events == "strikeout" ~ 1,
                               TRUE ~ 0)) %>%
  group_by(game_year, batter, stand, if_fielding_alignment) %>%
  mutate(bb_rate = sum(walk) / length(which(last_pitch_of_at_bat == TRUE)),
            k_rate = sum(strikeout) / length(which(last_pitch_of_at_bat == TRUE)),
            babip = mean(babip_value_with_NAs, na.rm = TRUE),
            woba = sum(woba_value, na.rm = TRUE) / length(which(last_pitch_of_at_bat == TRUE)))
```

# Training set

```{r}
statcast_data_minus_2020_2022 <- statcast_data_minus_2020_2022 %>%
  mutate(batter_instance_identifier = paste(batter, game_year, stand, if_fielding_alignment, sep = ":")) 
    
statcast_training_data_rf_identifiers <- statcast_data_minus_2020_2022 %>%
  select(game_year, batter, stand, if_fielding_alignment, batter_instance_identifier) %>%
  unique() %>%
  group_by(game_year, stand, if_fielding_alignment) %>%
  sample_frac(.2)

statcast_training_data <- statcast_data_minus_2020_2022 %>%
  filter(batter_instance_identifier %in% statcast_training_data_rf_identifiers$batter_instance_identifier)
```




# Random forest and variable of importance

```{r}
init_statcast_data_rf <- ranger(woba ~ ., data = statcast_training_data, num.trees = 500, importance = "impurity")
init_statcast_data_rf
```
When shifting takes place, how is wOBA affected?

control for shifting, batter info, pitcher info, handedness

Controlling for ability of hitter (batter's wOBA) -> this is the outcome on wOBA

mixed effects -> batter/pitcher

coeff. estimate for shifts

formal inference (use whole data for learning) 

pitch type driving changes? easier for righties to hit righty CBs

Use last pitch of at-bat (modeling at at-bat level!)
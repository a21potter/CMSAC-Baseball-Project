---
title: "Baseball-R-Dataset"
author: "Nicholas Esposito and Amber Potter"
date: "7/6/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Dataset

```{r}
library(baseballr)
library(tidyverse)

bref_standings_on_date("2022-07-06", "AL East", from = FALSE)

# statcast_data <- statcast_search_batters("2022-04-01", Sys.Date())
```
## Download Batter Data

```{r}
statcast_data_batters <- statcast_search_batters(start_date = "2022-04-01", 
                                                 end_date = Sys.Date())

statcast_data_batters %>%
  distinct(description)
```

## Download Pitcher Data

```{r}
statcast_data_pitchers <- statcast_search_pitchers(start_date = "2022-04-01",
                                                   end_date = Sys.Date())

statcast_data_batters %>%
  distinct(description)
```


## Cleaning

```{r}
# Clean the batting data - Remove N/As and fix strikeout cols
statcast_data_batters <- statcast_data_batters[ , colSums(is.na(statcast_data_batters)) < nrow(statcast_data_batters)]

statcast_data_batters <- statcast_data_batters %>%
  mutate(pitch_outcome = case_when(events != "" ~ events,
                                   events == "" ~ description)) %>%
  mutate(pitch_outcome = case_when(events == "strikeout" & description == "swinging_strike" ~ "strikeout_swinging",
                                   events == "strikeout" & description == "called_strike" ~ "strikeout_called",
                                   TRUE ~ pitch_outcome),
         game_id = game_pk) %>%
  select(-game_pk)

# Clean the pitching data - Remove N/As and fix strikeout cols
statcast_data_pitchers <- statcast_data_pitchers[ , colSums(is.na(statcast_data_pitchers)) < nrow(statcast_data_pitchers)]

statcast_data_pitchers <- statcast_data_pitchers %>%
  mutate(pitch_outcome = case_when(events != "" ~ events,
                                   events == "" ~ description)) %>%
  mutate(pitch_outcome = case_when(events == "strikeout" & description == "swinging_strike" ~ "strikeout_swinging",
                                   events == "strikeout" & description == "called_strike" ~ "strikeout_called",
                                   TRUE ~ pitch_outcome),
         game_id = game_pk) %>%
  select(-game_pk)
```

## Create AB counter columns and merge by game ID

```{r}
# Add at-bat column for batting data (1, 2, 3...)
statcast_data_batters_at_bats <- statcast_data_batters %>%
  count(game_id, batter, at_bat_number) %>%
  group_by(game_id, batter) %>%
  mutate(at_bat_of_game=1:n()) 

# Merge to original dataframe
statcast_data_batters <- statcast_data_batters %>%
  left_join(statcast_data_batters_at_bats, 
            by = c("game_id" = "game_id", "batter" = "batter", "at_bat_number" = "at_bat_number")) %>%
  select(-n)

# Add at-bat column for pitching data (1, 2, 3...)
statcast_data_pitchers_at_bats <- statcast_data_pitchers %>%
  count(game_id, batter, at_bat_number) %>%
  group_by(game_id, batter) %>%
  mutate(at_bat_of_game=1:n()) 

# Merge to original dataframe
statcast_data_pitchers <- statcast_data_pitchers %>%
  left_join(statcast_data_pitchers_at_bats, by = c("game_id" = "game_id", "batter" = "batter", "at_bat_number" = "at_bat_number"))  %>%
  select(-n)
```

## Counts and Percentages of Sample

```{r}
statcast_data_batters %>%
  filter(!if_fielding_alignment == "", !of_fielding_alignment == "") %>%
  #select(stand, p_throws, if_fielding_alignment, of_fielding_alignment) %>%
  count(stand, p_throws, if_fielding_alignment, of_fielding_alignment) %>%
  mutate(prob = n/sum(n))
```


```{r}
statcast_data_batters %>%
  filter(!if_fielding_alignment == "", !of_fielding_alignment == "") %>%
  mutate(if_fielding_alignment = case_when(if_fielding_alignment == "Infield shift" ~ "Shift",
                                           if_fielding_alignment == "Strategic" ~ "Shift",
                                           if_fielding_alignment == "Standard" ~ "Standard")) %>%
  mutate(of_fielding_alignment = case_when(of_fielding_alignment == "4th outfielder" ~ "Shift",
                                           of_fielding_alignment == "Strategic" ~ "Shift",
                                           of_fielding_alignment == "Standard" ~ "Standard")) %>%
  #select(stand, p_throws, if_fielding_alignment, of_fielding_alignment) %>%
  count(stand, p_throws, if_fielding_alignment, of_fielding_alignment) %>%
  mutate(prob = n/sum(n))
```

```{r}
statcast_data_batters %>%
  #select(stand, p_throws, if_fielding_alignment, of_fielding_alignment) %>%
  count(stand, p_throws) %>%
  mutate(prob = n/sum(n))
```

## Prelim. Spray Charts

```{r}
statcast_data_batters %>%
  filter(stand == "R", p_throws == "L") %>%
  ggspraychart("hc_x", "-hc_y", bin_size = 100, point_alpha = 0.25, frame = TRUE) +
  facet_grid()
```


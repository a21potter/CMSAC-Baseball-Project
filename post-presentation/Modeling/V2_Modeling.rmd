---
title: "Modeling"
author: "Amber Potter and Nicholas Esposito"
date: "10/26/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load in dataset

```{r}
library(baseballr)
library(glue)
library(tidyverse)
library(knitr)
library(ranger)
library(mgcv)
library(dplyr)
library(ggfortify)
library(broom)
#library(questionr)
#library(sjPlot)
#library(sjmisc)
#library(effects)
#library(pscl)
library(caret)
V2_statcast_data_modeling <- read_rds("post-presentation/V2_data/V2_statcast_data_modified.rds")

V2_statcast_data_modeling <- V2_statcast_data_modeling %>%
  mutate(woba_value = as.factor(woba_value))

## Filter out 2018

V2_statcast_data_modeling <- V2_statcast_data_modeling %>%
  filter(game_year != 2018)

#mutate(on_base_binary = case_when((woba_value == 0 | last_pitch_of_at_bat == FALSE) ~ 0,
                                    #TRUE ~ 1))
```


# Find Proportions

** slight change of plans, im gonna include proportion of the pitch type that they ended up hitting within an at bat... its easier and we can make an argument for it 

- ex) if they hit a fast ball, and they saw 4 fastballs out of 5 total pitches, the prop will be 4/5

- i think this is more relevant to what they actually do in the at bat

correct me if im wrong, but what does it matter the types of pitches they saw besides the type they hit. like if they hit a breaking ball and it was the only breaking ball they saw, that seems relevant. but it isnt really relevant that they saw one breaking ball if they hit one of the 4 fastballs they saw out of the 5 total pitches?? do you get my logic? its more like, could they get used to the pitch


i did the same with pitch zone, which i think is less ideal, but still arguable. if i have time to figure out how to do it otherwise, i will

```{r}
# slight change of plans - instead of 
V2_statcast_data_modeling <- V2_statcast_data_modeling %>%
  group_by(game_id, batter, at_bat_number, general_pitch_type) %>%
  mutate(pitch_type_count_per_atbat = n()) %>%
  #ungroup(general_pitch_type) %>%
  mutate(prop_pitch_type_hit_per_atbat = pitch_type_count_per_atbat/pitch_count) %>%
  ungroup()


V2_statcast_data_modeling <- V2_statcast_data_modeling %>%
  group_by(game_id, batter, at_bat_number, zone_simp) %>%
  mutate(pitch_zone_count_per_atbat = n()) %>%
  ungroup(zone_simp) %>%
  mutate(prop_pitch_zone_per_atbat = pitch_zone_count_per_atbat/pitch_count) %>%
  ungroup()
```


## At bat level data

```{r}
V2_statcast_data_modeling_atbats <- V2_statcast_data_modeling %>%
  group_by(game_id, batter, at_bat_number) %>%
  #arrange(pitch_number) %>%
  mutate(pitch_count = max(pitch_number),
         last_pitch_of_at_bat = case_when(pitch_number == pitch_count ~ TRUE,
                                          TRUE ~ FALSE)) %>%
  ungroup() %>%
 filter(last_pitch_of_at_bat == TRUE)
```


# Filter For Batter At Bat Outcomes

```{r}
V2_statcast_data_modeling_atbats %>%
  
```



# Split dataset by handedness

```{r}
V2_modeling_R_shift <- V2_statcast_data_modeling_atbats %>%
  filter(stand == "R") %>%
  filter(general_fielding_alignment == "Shift")

V2_modeling_L_shift <- V2_statcast_data_modeling_atbats %>%
  filter(stand == "L") %>%
  filter(general_fielding_alignment == "Shift")
```


# Logistic Modeling

"Two populations we are exploring" -> Righties and Lefties

Interactions with shifts for all predictors (ex: outs*if_fielding_alignment) EXCEPT PLAYER NAME

Add proportion of pitch location

Total # of pitches

Control for player and year

*** add pitch count to model, add zone_simp*general_fielding_alignment, add stand -- model takes a while, but not forever. but it takes me longer on shitty phone hotspot
maybe remove interaction between p_throws and fielding alignment? id rather have interactions be related to batter (do not include interactions with batter variable directly lmao)

# Right-handed model
```{r}
init_logistic_model_R <- glm(on_base_binary ~ p_throws +
                             pitch_count*general_fielding_alignment +
                             general_pitch_type*general_fielding_alignment +
                             prop_pitch_type_hit_per_atbat+
                             prop_pitch_zone_per_atbat+
                             zone_simp*general_fielding_alignment +
                             batter +
                             game_year, 
                        data = V2_modeling_R, 
                        family = "binomial")

init_logistic_model_R_shift <- glm(on_base_binary ~ p_throws +
                             pitch_count+
                             general_pitch_type +
                             prop_pitch_type_hit_per_atbat+
                             prop_pitch_zone_per_atbat+
                             zone_simp+
                             batter +
                             game_year, 
                        data = V2_modeling_R_shift, 
                        family = "binomial")

summary(init_logistic_model_R_shift)
#tab_model(init_logistic_model, p.style = "numeric_stars", transform = NULL, ci_method="wald")

model_variables_R <- c(names(init_logistic_model_R_shift$coefficients))
model_coefficients_R <- as.data.frame(init_logistic_model_R_shift$coefficients)[,1]
model_exp_coefficients_R <- as.data.frame(exp(init_logistic_model_R_shift$coefficients))[,1]

model_pvals_R <- as.data.frame(coef(summary(init_logistic_model_R_shift))[,4])[,1]

model_R_output <- data.frame(model_variables_R, 
           model_coefficients_R, 
           model_exp_coefficients_R,
           model_pvals_R) %>%
  filter(!grepl("batter", model_variables_R, fixed = TRUE))

```

# Left-handed model
```{r}
init_logistic_model_L <- glm(on_base_binary ~ p_throws +
                             pitch_count*general_fielding_alignment +
                             general_pitch_type*general_fielding_alignment +
                             prop_pitch_type_hit_per_atbat+
                             prop_pitch_zone_per_atbat+
                             zone_simp*general_fielding_alignment +
                             batter +
                             game_year, 
                        data = V2_modeling_L, 
                        family = "binomial")


init_logistic_model_L_shift <- glm(on_base_binary ~ p_throws +
                             pitch_count+
                             general_pitch_type +
                             prop_pitch_type_hit_per_atbat+
                             prop_pitch_zone_per_atbat+
                             zone_simp+
                             batter +
                             game_year, 
                        data = V2_modeling_L_shift, 
                        family = "binomial")

summary(init_logistic_model_L)
#tab_model(init_logistic_model, p.style = "numeric_stars", transform = NULL, ci_method="wald")

model_variables_L <- c(names(init_logistic_model_L$coefficients))
model_coefficients_L <- as.data.frame(init_logistic_model_L$coefficients)[,1]
model_exp_coefficients_L <- as.data.frame(exp(init_logistic_model_L$coefficients))[,1]

model_pvals_L <- as.data.frame(coef(summary(init_logistic_model_L))[,4])[,1]

model_L_output <- data.frame(model_variables_L, 
           model_coefficients_L, 
           model_exp_coefficients_L,
           model_pvals_L) %>%
  filter(!grepl("batter", model_variables_L, fixed = TRUE))

```


```{r}
model_R_output_simp <- model_R_output %>%
  filter(model_variables_R %in% c("pitch_count", "prop_pitch_type_hit_per_atbat", "general_pitch_typeBreaking Ball", "general_pitch_typeChangeup", "prop_pitch_zone_per_atbat", "prop_pitch_zone_per_atbat", "zone_simpOutside",   "general_fielding_alignmentStandard:general_pitch_typeChangeup", "general_fielding_alignmentStandard:zone_simpOutside")) %>%
  mutate(Variable = c("Total Pitches", "Breaking Ball", "Changeup", "Prop Last Seen Pitch Type", "Prop Last Seen Pitch Zone", "Outside Pitch", "Total Pitches:Standard Alignment", "Breaking Ball:Standard Alignment", "Changeup:Standard Alignment", "Outside Pitch:Standard Alignment")) %>%
  select(Variable, model_coefficients_R, model_exp_coefficients_R, model_pvals_R) %>%
  kable(digits = 4, col.names = c("Variables", "Coefficients", "Exponentiated Coefficients", "P-Value"))

saveRDS(model_R_output_simp, file = "post-presentation/V2_data/model_R_output_simp.rds")

model_L_output_simp <- model_L_output %>%
  filter(model_variables_L %in% c("pitch_count", "prop_pitch_type_hit_per_atbat", "general_pitch_typeBreaking Ball", "general_pitch_typeChangeup", "prop_pitch_zone_per_atbat", "prop_pitch_zone_per_atbat", "zone_simpOutside", "pitch_count:general_fielding_alignmentStandard", "general_fielding_alignmentStandard:general_pitch_typeBreaking Ball", "general_fielding_alignmentStandard:general_pitch_typeChangeup", "general_fielding_alignmentStandard:zone_simpOutside")) %>%
  mutate(Variable = c("Total Pitches", "Breaking Ball", "Changeup", "Prop Last Seen Pitch Type", "Prop Last Seen Pitch Zone", "Outside Pitch", "Total Pitches:Standard Alignment", "Breaking Ball:Standard Alignment", "Changeup:Standard Alignment", "Outside Pitch:Standard Alignment")) %>%
  select(Variable, model_coefficients_L, model_exp_coefficients_L, model_pvals_L) %>%
  kable(digits = 4, col.names = c("Variables", "Coefficients", "Exponentiated Coefficients", "P-Value"))

saveRDS(model_L_output_simp, file = "post-presentation/V2_data/model_L_output_simp.rds")
```
prop_pitch_type_hit_per_atbat
zone_simpMiddle
zone_simpOutside

```{r}

V2_modeling_R <- V2_modeling_R %>%
#  filter(last_pitch_of_at_bat == TRUE) %>%
  mutate(walk = case_when(events == "walk" ~ 1,
                          TRUE ~ 0),
         hr = case_when(events == "home_run" ~ 1,
                          TRUE ~ 0),
         strikeout = case_when(events == "strikeout" ~ 1,
                               TRUE ~ 0)) %>%
  group_by(game_year, batter, stand, if_fielding_alignment) %>%
  mutate(bb_rate = sum(walk) / length(which(last_pitch_of_at_bat == TRUE)),
         hr_rate = sum(hr) / length(which(last_pitch_of_at_bat == TRUE)),
            k_rate = sum(strikeout) / length(which(last_pitch_of_at_bat == TRUE))) %>%
  ungroup()

V2_modeling_L <- V2_modeling_L %>%
#  filter(last_pitch_of_at_bat == TRUE) %>%
  mutate(walk = case_when(events == "walk" ~ 1,
                          TRUE ~ 0),
         hr = case_when(events == "home_run" ~ 1,
                          TRUE ~ 0),
         strikeout = case_when(events == "strikeout" ~ 1,
                               TRUE ~ 0)) %>%
  group_by(game_year, batter, stand, if_fielding_alignment) %>%
  mutate(bb_rate = sum(walk) / length(which(last_pitch_of_at_bat == TRUE)),
         hr_rate = sum(hr) / length(which(last_pitch_of_at_bat == TRUE)),
            k_rate = sum(strikeout) / length(which(last_pitch_of_at_bat == TRUE))) %>%
  ungroup()
```

# T-test Pitch Count

```{r}
shifted_R <- V2_modeling_R %>%
  filter(general_fielding_alignment == "Shift")

shifted_L <- V2_modeling_L %>%
  filter(general_fielding_alignment == "Shift")

standard_R <- V2_modeling_R %>%
  filter(general_fielding_alignment == "Standard")

standard_L <- V2_modeling_L %>%
  filter(general_fielding_alignment == "Standard")



t.test(standard_L$pitch_count, shifted_L$pitch_count)


```


# T-test Walk Rate

```{r}

t_tests <- map_df(list(t.test(shifted_R$bb_rate, standard_R$bb_rate),
                       t.test(shifted_L$bb_rate, standard_L$bb_rate),
                       t.test(shifted_R$hr_rate, standard_R$hr_rate),
                       t.test(shifted_L$hr_rate, standard_L$hr_rate)), tidy) %>%
  mutate(Rate = c("BB Rate", "BB Rate", "HR Rate", "HR Rate"),
         `Batter Handedness`= c("Right", "Left", "Right", "Left")) %>%
  select(method, `Batter Handedness`, Rate, conf.low, conf.high) %>%
  kable(digits = 4, col.names = c("Method", "Batter Handedness", "Average Rate", "95% Conf. Int. Lower Bound", "95% Conf. Int. Upper Bound"))

t.test(shifted_R$bb_rate, standard_R$bb_rate)

t.test(shifted_L$bb_rate, standard_L$bb_rate)


saveRDS(t_tests, file = "post-presentation/V2_data/t_tests.rds")

t.test(standard_R$bb_rate, standard_L$bb_rate)


```

# T-test HR Percentage

```{r}
t.test(shifted_R$hr_rate, shifted_L$hr_rate)

t.test(standard_R$hr_rate, standard_L$hr_rate)

```

```{r}
V2_modeling_R %>%
  select(batter, hr_rate, general_fielding_alignment) %>%
  unique() %>%
  ggplot(aes(x = hr_rate, fill = general_fielding_alignment)) +
  geom_histogram() +
  facet_wrap(~general_fielding_alignment)

V2_modeling_L %>%
  select(batter, hr_rate, general_fielding_alignment) %>%
  unique() %>%
  ggplot(aes(x = hr_rate, fill = general_fielding_alignment)) +
  geom_histogram() +
  facet_wrap(~general_fielding_alignment)
```



# Plot the results of the model

```{r}
pR2(init_logistic_model)
```

```{r}
varImp(init_logistic_model)
```
```{r}
autoplot(init_logistic_model)
```



